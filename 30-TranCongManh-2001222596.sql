CREATE DATABASE QL_DATHANG
USE QL_DATHANG
--Cau 1
CREATE TABLE NHACC
(
MACC VARCHAR(30) NOT NULL,
TENNCC NVARCHAR(40),
DCHI NVARCHAR(40),
DTHOAI VARCHAR(15),
CONSTRAINT PK_NHACC PRIMARY KEY (MACC)
)

CREATE TABLE SANPHAM
(
MASP VARCHAR(30) NOT NULL,
TENSP NVARCHAR(40),
DVT NVARCHAR(10),
DONGIA MONEY,
CONSTRAINT PK_SANPHAM PRIMARY KEY (MASP)
)

CREATE TABLE PHIEUDATHANG
(
MAPDH VARCHAR(30) NOT NULL,
NGAYDH DATE,
NGAYGIAODK DATE,
THANHTIEN MONEY,
MACC VARCHAR(30) NOT NULL,
CONSTRAINT PK_PHIEUDATHANG PRIMARY KEY (MAPDH),
CONSTRAINT FK_PHIEUDATHANG_NHACC FOREIGN KEY (MACC) REFERENCES NHACC (MACC)
)
CREATE TABLE CHITIETDH
(
MAPDH VARCHAR(30) NOT NULL,
SLDAT INT,
DGDAT MONEY,
MASP VARCHAR(30) NOT NULL,
CONSTRAINT PK_CHITIETDH PRIMARY KEY (MAPDH, MASP),
CONSTRAINT FK_CHITIETDH_PHIEUDATHANG FOREIGN KEY (MAPDH) REFERENCES PHIEUDATHANG (MAPDH),
CONSTRAINT FK_CHITIETDH_SANPHAM FOREIGN KEY (MASP) REFERENCES SANPHAM (MASP)
)
--Cau 2
--a
ALTER TABLE PHIEUDATHANG
ADD CONSTRAINT DF_PHIEUDATHANG DEFAULT 0 FOR THANHTIEN
--b
CREATE TRIGGER KT_PHIEUDATHANG ON PHIEUDATHANG FOR
INSERT,UPDATE AS
BEGIN
UPDATE PHIEUDATHANG
SET NGAYDH=GETDATE()
END
--C 
CREATE TRIGGER KT_AUTOUP_PHIEUDATHANG ON PHIEUDATHANG FOR
INSERT,UPDATE AS
BEGIN
IF (SELECT COUNT(*) FROM CHITIETDH) > 0 
BEGIN
UPDATE PHIEUDATHANG
SET THANHTIEN=( SELECT CHITIETDH.SLDAT*CHITIETDH.DGDAT FROM PHIEUDATHANG,CHITIETDH WHERE CHITIETDH.MAPDH=PHIEUDATHANG.MAPDH) 
END
END

 --Cau 3
 INSERT INTO NHACC VALUES
 ('NH001',N'Phúc Thịnh',N'Đà Nẵng','5435358493812'),
  ('NH002',N'Văn Tèo',N'Đồng Tháp','7545927'),
  ('NH003',N'Mai Thị',N'Hà Nội','5435358493812')
 INSERT INTO SANPHAM VALUES
 ('SP001',N'Nước uống',N'Lít',1000000),
  ('SP002',N'Thức ăn',N'Cái',200000),
  ('SP003',N'Thiết bị',N'Cái',350000)
 SET DATEFORMAT dmy
   INSERT INTO PHIEUDATHANG VALUES
 ('PDH001','2024-06-12','2024-06-26',2500000,'NH001'),
  ('PDH002','2012-05-27','2013-01-15',2840000,'NH001'),
  ('PDH003','2015-01-20','2025-01-22',3590000,'NH001'),
  ('PDH004','2014-09-13','2015-10-22',490000,'NH003')
     INSERT INTO CHITIETDH VALUES
 ('PDH001',10,1000000,'SP001'),
  ('PDH002',20,2840000,'SP002'),
  ('PDH003',30,3590000,'SP003'),
  ('PDH004',15,490000,'SP001')
  --Cau 4 A
  SELECT PHIEUDATHANG.*
  FROM PHIEUDATHANG,NHACC
  WHERE PHIEUDATHANG.MACC=NHACC.MACC AND NHACC.TENNCC=N'Phúc Thịnh' AND THANHTIEN>2000000 AND NGAYDH='2024-06-12'
  --B
  SELECT MASP, TENSP, COUNT(*) AS SLDH
  FROM SANPHAM
  GROUP BY MASP, TENSP
 --C
 SELECT NHACC.MACC, TENNCC
 FROM NHACC,PHIEUDATHANG
 WHERE PHIEUDATHANG.MACC=NHACC.MACC 
 GROUP BY NHACC.MACC, TENNCC
 HAVING COUNT(*)>=3
 --D 
 SELECT MASP, TENSP
 FROM SANPHAM
 WHERE SANPHAM.MASP = (SELECT SANPHAM.MASP FROM CHITIETDH,SANPHAM,PHIEUDATHANG WHERE CHITIETDH.MASP=SANPHAM.MASP AND CHITIETDH.MAPDH=PHIEUDATHANG.MAPDH
 AND MONTH(PHIEUDATHANG.NGAYDH)=6 AND YEAR(PHIEUDATHANG.NGAYDH)=2024 HAVING  )
 GROUP BY MASP, TENSP

 SELECT MAX(SANPHAM.MASP) AS N'Sản phẩm ĐHNN'
 FROM CHITIETDH,SANPHAM,PHIEUDATHANG
 WHERE CHITIETDH.MASP=SANPHAM.MASP AND CHITIETDH.MAPDH=PHIEUDATHANG.MAPDH
 AND MONTH(PHIEUDATHANG.NGAYDH)=6 AND YEAR(PHIEUDATHANG.NGAYDH)=2024
 GROUP BY SANPHAM.MASP 
