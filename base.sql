CREATE DATABASE QL_NV
USE QL_NV
CREATE TABLE KHOA
( MAKH CHAR(15) NOT NULL,
TENKH NVARCHAR(30),
CONSTRAINT PK_KHOA PRIMARY KEY(MAKH)
)
CREATE TABLE LOP
(
 MALOP CHAR(15) NOT NULL,
TENLOP NVARCHAR(30),
SISO int,
LOPTRUONG NVARCHAR(40),
MAKH CHAR(15) NOT NULL,
CONSTRAINT PK_LOP PRIMARY KEY(MALOP),
CONSTRAINT FK_KHOA_LOP FOREIGN KEY(MAKH) REFERENCES KHOA(MAKH)
)
CREATE TABLE SINHVIEN
(MASV CHAR(15) NOT NULL,
HOTEN NVARCHAR(40),
NGAYSINH DATE,
GTINH NCHAR(3),
DIACHI NVARCHAR(40),
MALOP CHAR(15),
CONSTRAINT PK_SINHVIEN PRIMARY KEY(MASV),
CONSTRAINT FK_SINHVIEN_LOP FOREIGN KEY(MALOP) REFERENCES LOP(MALOP)                                                                                                                                                                                                                       
)
CREATE TABLE GIANGVIEN
( MAGV CHAR(15) NOT NULL,
TENGV NVARCHAR(30),
MAKH CHAR(15),
CONSTRAINT PK_GIANGVIEN PRIMARY KEY(MAGV),
CONSTRAINT FK_KHOA_GIANGVIEN FOREIGN KEY(MAKH) REFERENCES KHOA(MAKH)
)
CREATE TABLE MONHOC
( MAMH CHAR(15) NOT NULL,
TENMH NVARCHAR(30),
SOTC int,
CONSTRAINT PK_MONHOC PRIMARY KEY(MAMH)
)
CREATE TABLE DIEM
( MASV CHAR(15) ,
 MAMH CHAR(15),
LANTHI int,
DIEMTHI int,
CONSTRAINT PK_DIEM PRIMARY KEY(MASV,MAMH,LANTHI),
CONSTRAINT FK_DIEM_SINHVIEN FOREIGN KEY(MASV) REFERENCES SINHVIEN(MASV),
CONSTRAINT FK_DIEM_MONHOC FOREIGN KEY(MAMH) REFERENCES MONHOC(MAMH)
)
CREATE TABLE GIANGDAY
(
MAGV CHAR(15),
MAMH CHAR(15),
NAMHOC nvarchar(20),
HOCKY int,
CONSTRAINT PK_GIANGDAY PRIMARY KEY(MAGV,MAMH),
CONSTRAINT FK_GIANGDAY_MONHOC FOREIGN KEY(MAMH) REFERENCES MONHOC(MAMH),
CONSTRAINT FK_GIANGDAY_GIANGVIEN FOREIGN KEY(MAGV) REFERENCES GIANGVIEN(MAGV)
)
CREATE TABLE THANHNHAN
( MATN CHAR(15) NOT NULL,
HOTEN NVARCHAR(30),
GIOITINH NCHAR(3),
CONSTRAINT PK_THANHNHAN PRIMARY KEY(MATN)
)
CREATE TABLE QUANHE
( MATN CHAR(15) ,
MASV CHAR(15) ,
QUANHE nvarchar(15),
CONSTRAINT PK_QUANHE PRIMARY KEY(MATN,MASV),
CONSTRAINT FK_QUANHE_THANHNHAN FOREIGN KEY(MATN) REFERENCES THANHNHAN(MATN),
CONSTRAINT FK_QUANHE_SINHVIEN FOREIGN KEY(MASV) REFERENCES SINHVIEN(MASV)
)
INSERT INTO KHOA VALUES
('SH', N'Công nghệ sinh học'),
('TH', N'Công nghệ thông tin'),
('TP', N'Công nghệ thực phẩm'),
('QT', N'Quản trị kinh doanh'),
('TC', N'Tài chính kế toán')
INSERT INTO LOP VALUES
('10SHSH1', N'10 Đại học Sinh học 1',55,'SV008','SH'),
('10DHTH1', N'10 Đại học Tin học 1',50,'SV001','TH'),
('11DHTH2', N'11 Đại học Tin học 2',40,'SV005','TH'),
('12DHTC1', N'12 Đại học Tài chính 1',75,'SV009','TC'),
('12DHTP1', N'10 Đại học Thực phẩm 1',60,'SV001','TP')
SET DATEFORMAT dmy;
INSERT INTO SINHVIEN VALUES
('SV001', N'Trần Lệ Quyên', '21-01-1995', N'Nữ', N'TP.HCM', '10DHTH1'),
('SV002', N'Nguyễn Thế Bình', '4-06-1996', N'Nam', N'Tây Ninh','11DHTH2'),
('SV003', N'Tô Ánh Nguyệt', '02-05-1976', N'Nữ', N'Vũng Tàu','12DHTP1'),
('SV004', N'Nguyễn Thế Anh', '15-12-1996', N'Nam', N'Đồng Nai','12DHTP1'),
('SV005', N'Lê Thanh Bình', '09-12-1994', N'Nam', N'Long An','10DHTH1'),
('SV006', N'Phạm Quang Hậu', '12-10-1995', N'Nam', N'Tây Ninh', '10DHTH1'),
('SV007', N'Lê Cẩm Tú', '13-02-1989', N'Nữ', N'Bình Thuận', '12DHTP1'),
('SV008', N'Trương Thế Sang', '04-04-1993', N'Nam', N'Bình Dương', '10SHSH1'),
('SV009', N'Đậu Quang Ánh', '03-12-1994', N'Nam', N'Long An', '12DHTC1'),
('SV010', N'Huỳnh Kim Chi', '18-10-1997', N'Nữ', N'TP.HCM', '11DHTH2'),
('SV011', N'Trịnh Đình Ánh', '15-11-1995', N'Nam', N'Bình Thuận', '10DHTH1')
INSERT INTO GIANGVIEN VALUES
('GV001', N'Phạm Thế Bảo','TH'),
('GV002', N'Lê Thế Quyền','TH'),
('GV003', N'Trương Anh Dũng','SH'),
('GV004', N'Bùi Chí Anh','TC'),
('GV005', N'Lê Công Hậu','QT'),
('GV006', N'Lê Trung Thành','TP')

INSERT INTO MONHOC VALUES
('CSDL', N'Cơ sở dũ liệu',3),
('KTLT', N'Kỹ thuật lâp trình',3),
('THVP', N'Tin học văn phòng',3),
('TRR', N'Toán rời rạc',3),
('TTNT', N'Trí tuệ nhân tạo',2),
('TTQT', N'Thanh toán quốc tế',2)
INSERT INTO DIEM VALUES
('SV001','CSDL', 1,9),
('SV002','THVP', 1,3),
('SV002','THVP', 2,7),
('SV004','THVP', 1,6),
('SV004','TTQT', 1,5),
('SV005','CSDL', 1,3),
('SV005','CSDL', 2,6),
('SV006','KTLT', 1,4),
('SV009','TTQT', 1,4),
('SV010','THVP', 1,8),
('SV010','TRR', 1,7)
INSERT INTO GIANGDAY VALUES
('GV001','CSDL','2021-2022',1),
('GV001','KTLT','2020-2021',2),
('GV001','TTNT','2020-2021',1),
('GV002','CSDL','2021-2022',2),
('GV002','KTLT','2021-2022',2)
INSERT INTO THANHNHAN VALUES
('TN001',N'Nguyễn Thế Thành',N'Nam'),
('TN002',N'Tô Ánh Hồng',N'Nữ'),
('TN003',N'Lê Thanh Anh',N'Nam'),
('TN004',N'Phạm Thanh Tiền',N'Nữ'),
('TN006',N'Đậu Văn Thanh',N'Nam'),
('TN007',N'Nguyễn Thị Ánh',N'Nữ'),
('TN008',N'Lê Quang Định',N'Nam'),
('TN009',N'Huỳnh Văn Tư',N'Nam')
INSERT INTO QUANHE VALUES
('TN001','SV002',N'Bố'),
('TN003','SV005',N'Bố'),
('TN004','SV007',N'Mẹ'),
('TN006','SV009',N'Bố'),
('TN007','SV002',N'Mẹ'),
('TN008','SV005',N'Bố'),
('TN008','SV007',N'Bố')

-- ALTER PK
ALTER TABLE A
ADD CONSTRAINT PK_A PRIMARY KEY (FK)

--FK 
ALTER TABLE B
ADD CONSTRAINT PK_A_B FOREIGN KEY (FK) REFERENCES B(PK) 

-- Đổi kiểu dữ liệu một cột
ALTER TABLE table_name
ALTER COLUMN column_name datatype

--UPDATE 
UPDATE TABLE
SET VALUE = VALUE +1
WHERE 

-- ADD BẢNG 
ALTER TABLE A
ADD COLUMN ACB NVARCHAR(50)

-- Xóa dòng 
DELETE FROM NHAVIEN
WHERE NHAN.MANV='NV001'

--XÓA BẢNG
DROP TABLE A

-- XÓA CỘT
ALTER TABLE A 
DROP COLUMN ACB

--Viết trong table RBTV 
create table CC (
CONSTRAINT CHK CHECK (LUONG >0)
CONSTRAINT UQE UNIQUE (TEPH)
CONSTRAINT DF DEFAULT 'UNSET' FOR ABC -- COLUM
)

--check 
ALTER TABLE NHANVIEN
ADD CONSTRAINT CHK_LUONG CHECK (LUONG> 0) 
--unique
ALTER TABLE NHANVIEN
ADD CONSTRAINT UNI_LUONG UNIQUE (LUONG)
--default
ALTER TABLE NHANVIEN
ADD CONSTRAINT DF_NHANVIEN DEFAULT NHANVIEN.LUONG='20000' FOR NHANVIEN 
--TRIGGER 
CREATE TRIGGER KT_SISO ON LOP FOR INSERT,UPDATE,DELETE
AS 
IF()
COMMIT TRAN
BEGIN
	UPDATE LOP
	SET SISO=SISO+1
	WHERE LOP.MALOP=(SELECT MALOP FROM inserted)
	UPDATE LOP
	SET SISO=SISO-1
	WHERE LOP.MALOP=(SELECT MALOP FROM deleted)
END